{% extends 'base.html' %}

{% block title %}Dashboard - DataSaaS{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Welcome Section -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-2">Welcome back, {{ user.first_name|default:user.username }}!</h1>
    <p class="text-base-content/70">Upload and analyze your CSV or Excel files to get instant insights.</p>
  </div>

  <!-- Upload Section -->
  <div class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4">
        <i class="fas fa-upload text-primary"></i>
        Upload Your Data
      </h2>
      
      <div class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center hover:border-primary transition-colors">
        <div class="space-y-4">
          <div class="text-6xl text-base-content/30">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div>
            <h3 class="text-xl font-semibold mb-2">Drag and drop your files here</h3>
            <p class="text-base-content/70">Supports CSV, Excel (.xlsx, .xls) files up to 100MB</p>
          </div>
          <div>
            <a href="{% url 'accounts:upload_file' %}" class="btn btn-primary">
              <i class="fas fa-folder-open mr-2"></i>
              Browse Files
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Analytics Section - Dynamic Stats -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Stats Cards -->
    <div class="stat bg-base-100 shadow-xl rounded-lg">
      <div class="stat-figure text-primary">
        <i class="fas fa-file-alt text-2xl"></i>
      </div>
      <div class="stat-title">Files Uploaded</div>
      <div class="stat-value text-primary">{{ total_files }}</div>
      <div class="stat-desc">Total files</div>
    </div>

    <div class="stat bg-base-100 shadow-xl rounded-lg">
      <div class="stat-figure text-secondary">
        <i class="fas fa-chart-line text-2xl"></i>
      </div>
      <div class="stat-title">Insights Generated</div>
      <div class="stat-value text-secondary">{{ total_insights }}</div>
      <div class="stat-desc">Total insights</div>
    </div>

    <div class="stat bg-base-100 shadow-xl rounded-lg">
      <div class="stat-figure text-accent">
        <i class="fas fa-download text-2xl"></i>
      </div>
      <div class="stat-title">Reports Downloaded</div>
      <div class="stat-value text-accent">{{ total_reports }}</div>
      <div class="stat-desc">All time</div>
    </div>
  </div>

  <!-- Recent Files Section -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title text-2xl">
          <i class="fas fa-history text-primary"></i>
          Recent Files
        </h2>
        {% if user_files %}
          <div class="flex space-x-2">
            <a href="{% url 'analytics:ml_jobs_list' %}" class="btn btn-secondary btn-sm">
              <i class="fas fa-robot mr-1"></i>
              View ML Jobs
            </a>
            <a href="{% url 'accounts:upload_file' %}" class="btn btn-outline btn-sm">Upload More</a>
          </div>
        {% endif %}
      </div>
      
      {% if user_files %}
        <!-- Files Table -->
        <div class="mb-4">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <span>Click the <strong>"Analyze"</strong> button next to any file to perform comprehensive EDA (Exploratory Data Analysis) including statistics, visualizations, and automated insights!</span>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>File Name</th>
                <th>Type</th>
                <th>Size</th>
                <th>Uploaded</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for file in user_files %}
                <tr>
                  <td>
                    <div class="flex items-center space-x-3">
                      <div class="avatar">
                        <div class="mask mask-squircle w-12 h-12 bg-primary/10 flex items-center justify-center">
                          {% if file.file_type == 'CSV' %}
                            <i class="fas fa-file-csv text-green-500 text-xl"></i>
                          {% elif file.file_type == 'XLSX' or file.file_type == 'XLS' %}
                            <i class="fas fa-file-excel text-green-600 text-xl"></i>
                          {% else %}
                            <i class="fas fa-file text-base-content/50 text-xl"></i>
                          {% endif %}
                        </div>
                      </div>
                      <div>
                        <div class="font-bold">{{ file.filename }}</div>
                        <div class="text-sm opacity-50">{{ file.file_type }} file</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge badge-outline">{{ file.file_type }}</span>
                  </td>
                  <td>{{ file.get_file_size_display }}</td>
                  <td>
                    <div class="text-sm">{{ file.uploaded_at|date:"M d, Y" }}</div>
                    <div class="text-xs opacity-50">{{ file.uploaded_at|time:"H:i" }}</div>
                  </td>
                  <td>
                    <div class="flex flex-wrap gap-1">
                      <a href="{% url 'analytics:eda_view' file.id %}" 
                         class="btn btn-primary btn-sm" 
                         title="Analyze Data">
                        <i class="fas fa-chart-line mr-1"></i>
                        EDA
                      </a>
                      <a href="{% url 'analytics:select_target_column' file.id %}" 
                         class="btn btn-secondary btn-sm" 
                         title="Train ML Model">
                        <i class="fas fa-robot mr-1"></i>
                        ML
                      </a>
                      <a href="{% url 'accounts:download_file' file.id %}" 
                         class="btn btn-outline btn-sm" 
                         title="Download">
                        <i class="fas fa-download"></i>
                      </a>
                      <button onclick="confirmDelete({{ file.id }}, '{{ file.filename }}')" 
                              class="btn btn-outline btn-error btn-sm" 
                              title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
          <div class="text-6xl text-base-content/20 mb-4">
            <i class="fas fa-inbox"></i>
          </div>
          <h3 class="text-xl font-semibold mb-2">No files uploaded yet</h3>
          <p class="text-base-content/70 mb-4">Upload your first CSV or Excel file to get started with data analysis.</p>
          <a href="{% url 'accounts:upload_file' %}" class="btn btn-primary">
            <i class="fas fa-plus mr-2"></i>
            Upload Your First File
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-8">
    <a href="{% url 'accounts:upload_file' %}" class="card bg-gradient-to-br from-primary to-primary-focus text-primary-content shadow-xl hover:shadow-2xl transition-shadow">
      <div class="card-body text-center">
        <i class="fas fa-chart-pie text-3xl mb-2"></i>
        <h3 class="font-bold">Upload & Analyze</h3>
        <p class="text-sm opacity-80">Get instant insights</p>
      </div>
    </a>

    <div class="card bg-gradient-to-br from-secondary to-secondary-focus text-secondary-content shadow-xl">
      <div class="card-body text-center">
        <i class="fas fa-table text-3xl mb-2"></i>
        <h3 class="font-bold">Data Preview</h3>
        <p class="text-sm opacity-80">View your data</p>
      </div>
    </div>

    <div class="card bg-gradient-to-br from-accent to-accent-focus text-accent-content shadow-xl">
      <div class="card-body text-center">
        <i class="fas fa-file-export text-3xl mb-2"></i>
        <h3 class="font-bold">Export Data</h3>
        <p class="text-sm opacity-80">Download results</p>
      </div>
    </div>

    <div class="card bg-gradient-to-br from-success to-success-focus text-success-content shadow-xl">
      <div class="card-body text-center">
        <i class="fas fa-cog text-3xl mb-2"></i>
        <h3 class="font-bold">Settings</h3>
        <p class="text-sm opacity-80">Customize analysis</p>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<dialog id="delete_modal" class="modal">
  <form method="dialog" class="modal-box">
    <h3 class="font-bold text-lg">Confirm Deletion</h3>
    <p class="py-4">Are you sure you want to delete "<span id="delete-filename"></span>"? This action cannot be undone.</p>
    <div class="modal-action">
      <button class="btn">Cancel</button>
      <a id="delete-link" href="#" class="btn btn-error">Delete</a>
    </div>
  </form>
</dialog>

<script>
function confirmDelete(fileId, filename) {
    document.getElementById('delete-filename').textContent = filename;
    document.getElementById('delete-link').href = "{% url 'accounts:delete_file' 0 %}".replace('0', fileId);
    document.getElementById('delete_modal').showModal();
}
</script>
{% endblock %}
